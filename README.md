# Design-Doc: AI-Ассистент репетитора по математике (ЕГЭ)


## 1. Контекст проекта

### 1.1 Бизнес-задача
**Проблема:**
Репетиторы (как минимум я) тратят много времени на рутинную проверку домашних заданий, их придумывание, до и просто много информации о каждом из учеников держат в голове, вместо того чтобы оптимизировать эти процессы и работать над стратегией подготовки. Ученики, сталкиваясь с трудностью при выполнении ДЗ, не имеют возможности получить мгновенную квалифицированную подсказку, что приводит либо к списыванию, либо к потере мотивации, а многие и вовсе не делают ДЗ, бывает даже говорят при этом, что всё сделали.

**Решение:**
Разработка Telegram-бота с гибридной RAG-системой, который:
1.  Автоматизирует процесс выдачи и проверки ДЗ (мгновенная сверка ответов).
2.  Выступает в роли **AI-тьютора**: в случае ошибки бот не выдает готовое решение, а анализирует ответ ученика и генерирует персонализированную наводящую подсказку, опираясь на эталонное решение из базы знаний.
3.  Собирает и визуализирует статистику прогресса для репетитора и ученика.
4.  При выполнении ДЗ добивается того, чтобы ученик точно хотя бы раз правильно решил задачу определённого типа

**Критерии успеха:**
*   **Для репетитора:** Сокращение времени на внеурочную проверку заданий и создания номеров для дз.
*   **Для ученика:** Получение валидной (математически корректной) подсказки в 90% случаев обращения, что позволяет довести задачу до решения самостоятельно.
*   (Субъективно) Если я буду чувствовать, что моя работа стала проще и качественнее, то всё будет не зря

### 1.2 Целевая аудитория и пользователи
*   **Репетитор (Администратор/Учитель):** Использует бота для назначения ДЗ, мониторинга успеваемости (выявление «слепых зон» ученика через аналитику тегов), пополнения базы задач.
*   **Ученик (Пользователь):** Решает задачи в удобном интерфейсе, получает подсказки 24/7, отслеживает свой прогресс (XP/Баллы/Рейтинг), получает напоминания о грядущих занятиях (опционально).
*   **Нагрузка:** На этапе MVP — до 20 (10-15) активных учеников. Основной сценарий — текстовый асинхронный режим.

### 1.3 Ограничения и допущения
*   **Домен:** Профильная математика ЕГЭ (специфика: работа с формулами, LaTeX, числовые ответы).
*   **Ограничение RAG:** Бот **не решает** произвольные задачи "из головы" во избежание ошибок. Он работает строго с верифицированной базой задач (Knowledge Base), используя LLM только для интерфейса и адаптации подсказок.
*   **Платформа:** Telegram (отсутствие web-интерфейса на старте упрощает разработку, но накладывает ограничения на UI) (возможно прикручу и веб версию, но пока не думал об этом).

---

## 2. Архитектура решения

### 2.1 Общая схема
`User (Telegram)` -> `Backend (Python/Aiogram)` -> `Orchestrator Logic`
-> 1. `SQL DB` (Поиск задачи по ID, хранение профиля юзера и логов)
-> 2. `Vector DB` (Поиск похожих задач для рекомендаций)
-> `LLM API` (Генерация подсказки на основе: *Условие + Эталонное решение + момент решения, на котором находится ученик*)

### 2.2 Хранилище знаний
*   **Тип:** Гибридное хранилище (Structured + Vector).
*   **Структура данных:**
    *   `PostgreSQL`: Хранение жесткой структуры — ID задачи, текст условия (LaTeX), эталонный ответ (число), пошаговое эталонное решение, расширенные метаданные.
    *   `Vector DB (ChromaDB / FAISS)`: Хранение эмбеддингов условий задач для реализации семантического поиска ("найти задачу, похожую на эту").

### 2.3 Retrieval + Generation
*   **Retrieval (Hybrid Search):**
    *   *Structured Retrieval:* Основной сценарий. Извлечение эталонного контекста по ID задачи (когда ученик решает заданный номер).
    *   *Semantic Search:* Дополнительный сценарий. Поиск задач-аналогов по векторам с фильтрацией по метаданным (например: "найти похожую задачу по теме 'Логарифмы' со сложностью 'Hard'").
*   **Generation:**
    *   LLM (GPT-5.2 / Claude Sonnet 4.5 Thinking / Gemini 3 Pro) используется как "Рассуждающий агент".
    *   Системный промпт ориентирован на роль "Сократического учителя", который задает наводящие вопросы, а не дает прямые ответы.

---

## 3. Данные и качество знаний

### 3.1 Сбор и предобработка данных
*   **Источники:** Открытые банки заданий ЕГЭ (ФИПИ, Mathege, РешуЕГЭ), собственные задачи.
*   **Формат:** Текст с разметкой LaTeX + опционально изображения + обычное текстовое решение.
*   **Предобработка:**
    1.  Очистка текста, нормализация формул.
    2.  **Auto-tagging (LLM Enrichment):** Каждая новая задача проходит через LLM-пайплайн для автоматической генерации метаданных (тегирование).

### 3.2 Векторизация и индексирование (Hybrid подход)
*   **Метаданные (Metadata):** Критически важны для качества рекомендаций. Каждая задача размечается тегами:
    *   `Subject`: Math Profile
    *   `Exam_Task_Number`: 1-19 (номер задания в ЕГЭ)
    *   `Topic`: "Trigonometry", "Derivative", "Inequalities" и тд
    *   `Difficulty`: 1-5 (Likert scale)
    *   `Solution_Method`: "Interval method", "Substitution" и тп
*   **Embedding Model:** `text-embedding-3-small` или `intfloat/multilingual-e5-large` (оптимизирована под разные языки).

### 3.3 Метрики качества знаний
*   **Correctness:** 100% математическая точность эталонных решений в базе (обеспечивается ручной валидацией при добавлении).
*   **Coverage:** Покрытие всех прототипов заданий ЕГЭ по математике.

---

## 4. Модель и генерация

### 4.1 Выбор LLM и промптинг
*   **Модель:** GPT-5.2 / Claude Sonnet 4.5 Thinking / Gemini 3 Pro или локальные модели (пока не чекал), если позволят ресурсы.
*   **Промпт-стратегия:** Chain-of-Thought (CoT). В промпт подается:
    1.  Роль: "Ты опытный репетитор".
    2.  Контекст: Текст задачи и *полное эталонное решение*.
    3.  Ввод пользователя: Неверный ответ или вопрос.
    4.  Инструкция: "Сравни ввод пользователя с эталоном. Найди этап, где могла возникнуть ошибка. Дай подсказку, указывающую на этот этап, но не пиши формулу целиком".

### 4.2 Контроль качества ответов
*   **Self-Consistency:** (Опционально) Генерация нескольких вариантов подсказки и выбор лучшей.
*   **User Feedback:** Кнопки под сообщением бота ("Помогло" / "Не помогло") для дообучения промптов в будущем.

---

## 5. UX / пользовательский опыт

### 5.1 Сценарии взаимодействия
1.  **"Решение ДЗ" (Основной):** Ученик получает список номеров -> Вводит ответ -> Получает вердикт. Если неверно -> Запрашивает подсказку (Hint).
2.  **"Работа над ошибками":** Бот предлагает решить задачу, аналогичную той, где была допущена ошибка (используя векторный поиск по базе).
3.  **"Статистика":** Репетитор получает отчет: "Миша застрял на логарифмах (5 ошибок подряд), но улучшил тригонометрию".

### 5.2 Диалоговая логика
*   **State Management:** Бот помнит контекст текущей решаемой задачи.
*   **Tone of Voice:** Поддерживающий, спокойный, наставнический. Без панибратства, но и без сухого канцелярита.

---

## 6. Безопасность, соответствие и этика

### 6.1 Риски и безопасность
*   **Риск:** Математические галлюцинации LLM (модель может выдумать несуществующее свойство логарифма, или уйти в тяжёлое решение и тп).
    *   *Mitigation:* Модель жестко ограничена контекстом (RAG). Ей запрещено использовать внешние знания для решения, она должна только "перефразировать" эталонное решение из базы ИЛИ поддержать решение ученика, если сложность решения не сильно превосходит сложность эталонного решения (здесь до конца ещё не додумал).
*   **Риск:** Prompt Injection (попытка ученика узнать ответ обманом).
    *   *Mitigation:* Системные инструкции игнорировать запросы типа "Скажи просто ответ", "Забудь инструкции".


### 6.2 Данные пользователей
*   Хранятся только Telegram ID, имя (display name) и история решений.
*   Данные используются исключительно для построения образовательной траектории.
