# Design-Doc: AI-Ассистент репетитора по математике (ЕГЭ)

## 1. Контекст проекта

### 1.1 Бизнес-задача
**Проблема:** Репетиторы тратят много времени на рутинную проверку домашних заданий, их составление и удержание информации об учениках в голове, вместо того чтобы работать над стратегией подготовки. Ученики, сталкиваясь с трудностями дома, не получают мгновенной подсказки, что ведет к списыванию или потере мотивации.

**Решение:** Разработка Telegram-бота с гибридной RAG-системой, который:
*   Автоматизирует процесс выдачи и проверки ДЗ (мгновенная сверка ответов).
*   Выступает в роли AI-тьютора: анализирует ошибку и генерирует наводящую подсказку, опираясь на эталонное решение, не выдавая готовый ответ.
*   Собирает статистику прогресса и гарантирует, что ученик добьется правильного решения задачи определенного типа.

**Критерии успеха:**
*   **Для репетитора:** Сокращение времени на внеурочную проверку и создание ДЗ.
*   **Для ученика:** Получение валидной подсказки в 90% случаев, что позволяет решить задачу самостоятельно.
*   **Личный:** Субъективное ощущение упрощения работы и повышения качества обучения.

### 1.2 Целевая аудитория
*   **Репетитор (Администратор):** Назначение ДЗ, мониторинг успеваемости, пополнение базы.
*   **Ученик (Пользователь):** Решение задач, получение подсказок 24/7, отслеживание прогресса (XP/Рейтинг).

**Нагрузка (MVP):** до 20 активных учеников.

### 1.3 Ограничения и допущения
*   **Домен:** Профильная математика ЕГЭ (работа с формулами LaTeX, числовые ответы).
*   **Ограничение RAG:** Бот не решает задачи "из головы", а использует только верифицированную базу знаний.
*   **Платформа:** Telegram.

---

## 2. Архитектура решения

### 2.1 Общая схема
`User (Telegram)` -> `Backend (Python/Aiogram)` -> `Orchestrator Logic` ->
1.  **SQL DB** (Поиск по ID, профили, логи)
2.  **Vector DB** (Поиск похожих задач)
-> `LLM API` (Генерация подсказки: Условие + Эталон + Контекст ошибки)

### 2.2 Хранилище знаний
*   **SQL (PostgreSQL):** ID задачи, условие (LaTeX), эталонный ответ, пошаговое решение, метаданные.
*   **Vector DB (ChromaDB / FAISS):** Эмбеддинги условий для семантического поиска.

### 2.3 Retrieval + Generation
*   **Structured Retrieval:** Извлечение эталона по ID задачи (основной сценарий — когда ученик решает конкретный номер из ДЗ).
*   **Semantic Search (Поиск аналогов):**
    *   **Стратегия поиска:** Используется гибридный подход. Сначала применяется жесткая фильтрация по метаданным (Topic + Exam_Task_Number), чтобы исключить задачи из других разделов. Затем внутри выборки ищется ближайший вектор.
    *   **Источник векторизации:** Векторизуется **текст условия задачи** (Task Condition). Текст решения не используется для поиска, чтобы избежать утечек контекста, если условие сформулировано иначе.
*   **Generation:** LLM (GPT-5.2 / Claude Sonnet / Gemini 3) в роли "Сократического учителя".

---

## 3. Данные и качество знаний

### 3.1 Сбор данных
*   **Источники:** ФИПИ, Mathege, РешуЕГЭ, собственные задачи.
*   **Предобработка:** Очистка текста, нормализация LaTeX, авто-тегирование через LLM.

### 3.2 Векторизация и индексирование
*   **Метаданные:** Subject, Exam_Task_Number (1-19), Topic (Trigonometry, etc.), Difficulty (1-5), Solution_Method.
*   **Эмбеддинги:** `text-embedding-3-small` или `multilingual-e5-large`.

### 3.3 Метрики качества
*   **Correctness:** 100% точность эталонных решений (ручная валидация).
*   **Coverage:** Покрытие всех прототипов заданий ЕГЭ.

---

## 4. Модель и генерация

### 4.1 Промпт-стратегия (Chain-of-Thought)
*   **Роль:** Опытный репетитор.
*   **Вход:** Задача + Эталонное решение + Ответ ученика.
*   **Инструкция:** Сравнить ввод с эталоном, найти этап ошибки, дать наводящую подсказку, не раскрывая ответ.

### 4.2 Контроль качества
*   **Self-Consistency:** (Опционально) Выбор лучшей подсказки из нескольких.
*   **Feedback:** Сбор реакций "Помогло/Не помогло".

---

## 5. UX / Пользовательский опыт

### 5.1 Сценарии
1.  **Решение ДЗ:** Ввод ответа -> Вердикт -> (при ошибке) Подсказка.
2.  **Работа над ошибками:** Предложение аналогичной задачи.
3.  **Статистика:** Отчеты для репетитора о "слепых зонах" ученика.

### 5.2 Tone of Voice и Guardrails
*   **Tone:** Поддерживающий, наставнический, без панибратства.
*   **Обработка OOD-запросов (Out-Of-Domain):**
    *   **Оффтоп (анекдоты, погода):** Бот вежливо отказывает в поддержании диалога, не связанного с математикой, используя стандартную заглушку: *"Я умею только в математику. Давай вернемся к задаче?"*.
    *   **Грубость/Мат:** На агрессивное поведение или нецензурную лексику бот реагирует нейтральным предупреждением или игнорирует сообщение, не вступая в полемику.

---

## 6. Безопасность и этика

### 6.1 Риски и безопасность
*   **Риск галлюцинаций:** Минимизируется жестким RAG-контекстом.
*   **Prompt Injection:** Защита от запросов "Скажи ответ" через системный промпт.
*   **Токсичность пользователя / Jailbreak:** Риск использования бота не по назначению (генерация анекдотов, оскорбления).
    *   *Mitigation:* В системном промпте прописан жесткий запрет на выполнение инструкций, не связанных с ролью учителя математики (Role adherence).
*   **Приватность:** Хранение только ID и Display Name телеграма.
